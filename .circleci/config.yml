version: 2.1

parameters:
  environment:
     type: string
     default: "ra-my-app-test"

commands:
  param-command:
      steps:
        - when:
            condition:
              or:
               - and:
                   - matches: { pattern: "^ra-[a-z0-9-]+$", value: << pipeline.parameters.environment >> }
            steps:
               - run: 
                   name: If this step runs then the condition matched!
                   command: echo "this step means it is running on env match!"
        - run:
            name: Fetch Subnet ID from EC2 metadata
            command: |
                echo "this is another step"
jobs:
  machine-medium:
    machine: true
    resource_class: medium
    steps:
      - checkout
      - param-command
            

workflows:
  env-match:
    when: 
      condition:
        and:
            - matches: { pattern: "^ra-[a-z0-9-]+$", value: << pipeline.parameters.environment >> }
    jobs:
      - machine-medium
      
  ec2-test:
    when: 
      condition:
        or:
            - equal: [ main, << pipeline.git.branch >> ]
            - matches: { pattern: "^v$", value: << pipeline.git.tag >> }
    jobs:
      - machine-medium
