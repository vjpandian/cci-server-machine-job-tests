version: 2.1

parameters:
  ttl-seconds:
     type: string
     default: "180"
  metadata-endpoint:
     type: string
     default: "http://169.254.169.254/latest/meta-data"
  api-token-endpoint:
     type: string
     default: "http://169.254.169.254/latest/api/token"

commands:
  fetch-instance-metadata:
      steps:
        - run:
            name: Fetch Subnet ID from EC2 metadata
            command: |
                TOKEN=$(curl -X PUT "<<pipeline.parameters.api-token-endpoint>>" -H "X-aws-ec2-metadata-token-ttl-seconds: << pipeline.parameters.ttl-seconds >>")
                curl -H "X-aws-ec2-metadata-token: $TOKEN" <<pipeline.parameters.metadata-endpoint>>/network/interfaces/macs/$(curl -H "X-aws-ec2-metadata-token: $TOKEN" <<pipeline.parameters.metadata-endpoint>>/mac)/subnet-id
        - run:
            name: Fetch Instance type from EC2 metadata
            command: |
                TOKEN=$(curl -X PUT "<<pipeline.parameters.api-token-endpoint>>" -H "X-aws-ec2-metadata-token-ttl-seconds: << pipeline.parameters.ttl-seconds >>")
                curl -H "X-aws-ec2-metadata-token: $TOKEN" <<pipeline.parameters.metadata-endpoint>>/instance-type

jobs:
  machine-medium:
    machine: true
    resource_class: medium
    steps:
      - checkout
      - fetch-instance-metadata
            

workflows:
  ec2-test:
    when: 
      condition:
        or:
            - equal: [ main, << pipeline.git.branch >> ]
            - matches: { pattern: "^v$", value: << pipeline.git.tag >> }
    jobs:
      - machine-medium
